<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Circle of Fifths</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: sans-serif;
      background: #fafafa;
    }

    #circle {
      position: relative;
      width: 380px;
      height: 380px;
      margin-top: 30px;
    }

    .layer {
      position: absolute;
      top: 50%;
      left: 50%;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 0;
    }

    .fill.major       { width: 330px; height: 330px; background: #d0f0d0; }
    .fill.minor       { width: 260px; height: 260px; background: #d0e8ff; }
    .fill.diminished  { width: 180px; height: 180px; background: #fce0ec; }
    .fill.center      { width: 100px; height: 100px; background: white; z-index: 6; }

    .ring {
      border: 1px solid black;
      background: transparent;
    }

    .ring.outer      { width: 330px; height: 330px; z-index: 3; }
    .ring.major      { width: 260px; height: 260px; z-index: 3; }
    .ring.minor      { width: 180px; height: 180px; z-index: 3; }
    .ring.diminished { width: 100px; height: 100px; z-index: 3; }

    .label {
      position: absolute;
      transform: translate(-50%, -50%);
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      z-index: 4;
      padding: 4px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .label:hover {
      transform: translate(-50%, -50%) scale(1.2);
      background: rgba(255, 255, 255, 0.9);
      z-index: 25;
    }

    .label.major { font-weight: bold; font-size: 14px; }
    .label.minor { font-style: italic; }
    .label.diminished { font-size: 11px; }

    .separator {
      position: absolute;
      width: 1px;
      height: 165px;
      top: 7%;
      left: 50%;
      background: black;
      transform-origin: bottom center;
      z-index: 5;
    }

    #info {
      margin-top: 20px;
      font-size: 0.8em;
    }

    /* Red overlay styles */
    #red-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: auto;
      cursor: grab;
    }
    #red-canvas.dragging {
      cursor: grabbing;
    }

    /* Highlighted key label */
    .highlighted-key {
      border: 2.5px dotted #222;
      border-radius: 50%;
      padding: 4px 8px;
      background: #fff8;
      box-shadow: 0 0 0 4px #fff8;
      z-index: 22;
    }

    .toggle-switch {
      display: inline-flex;
      border-radius: 20px;
      background: #eee;
      border: 1.5px solid #bbb;
      overflow: hidden;
      font-size: 1em;
      user-select: none;
    }
    .toggle-switch span {
      padding: 6px 16px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      color: #444;
    }
    .toggle-switch .active {
      background: #444;
      color: #fff;
    }

    .trash-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      color: #666;
      transition: color 0.3s;
      display: inline-block;
      vertical-align: middle;
    }

    .trash-button:hover {
      color: #ff4444;
    }

    .trash-button svg {
      width: 20px;
      height: 20px;
      display: block;
    }
  </style>
</head>
<body>
  <h2>Circle of Fifths</h2>
  <div style="margin-bottom: 10px;">
    <label for="mode-select">Mode: </label>
    <select id="mode-select">
      <option>Lydian</option>
      <option>Ionian</option>
      <option>Mixolydian</option>
      <option>Dorian</option>
      <option>Aeolian</option>
      <option>Phrygian</option>
      <option>Locrian</option>
    </select>
    <label for="key-select" style="margin-left: 20px;">Key: </label>
    <select id="key-select">
      <option>C</option>
      <option>G</option>
      <option>D</option>
      <option>A</option>
      <option>E</option>
      <option>B</option>
      <option>Gb</option>
      <option>Db</option>
      <option>Ab</option>
      <option>Eb</option>
      <option>Bb</option>
      <option>F</option>
    </select>
  </div>
  <div id="info">Drag the circle left or right to change key</div>
  <div id="circle">
    <!-- Colored fills -->
    <div class="layer fill major"></div>
    <div class="layer fill minor"></div>
    <div class="layer fill diminished"></div>

    <!-- Circle ring outlines -->
    <div class="layer ring outer"></div>
    <div class="layer ring major"></div>
    <div class="layer ring minor"></div>
    <div class="layer ring diminished"></div>

    <!-- White center circle -->
    <div class="layer fill center"></div>

    <!-- This div will contain the chord labels -->
    <div id="chord-labels"></div>

    <!-- Red overlay (HTML/CSS only) -->
    <canvas id="red-canvas" width="380" height="380"></canvas>
  </div>
  <div style="margin-top: 10px; display: flex; gap: 30px; align-items: center;">
    <div id="roman-toggle" class="toggle-switch">
      <span id="roman-chords" class="active">Chords/Keys</span>
      <span id="roman-roman">Roman numerals</span>
    </div>
    <div id="draw-toggle" class="toggle-switch">
      <span id="draw-normal" class="active">Transpose Key</span>
      <span id="draw-drawing">Draw Chord Progression</span>
    </div>
    <button id="clear-drawings" class="trash-button" style="margin-left: 10px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 6h18"></path>
        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
      </svg>
    </button>
  </div>

  <!-- Add text field for chord progression -->
  <div style="margin-top: 20px; width: 80%; max-width: 600px;">
    <input type="text" id="chord-progression" readonly style="width: 100%; padding: 8px; font-size: 16px; text-align: center; border: 1px solid #ccc; border-radius: 4px;">
  </div>

  <script type="module">
    import { RING, CIRCLE_POSITIONS, getChordNameAtPosition, getChordPolarCoordinates, polarToCartesian } from './chord-position-map.js';
    import { ChordHighlighter } from './chord-highlight.js';

    // Basic initialization
    const circle = document.getElementById('circle');
    const info = document.getElementById('info');
    const modeSelect = document.getElementById('mode-select');
    const keySelect = document.getElementById('key-select');
    const romanToggle = document.getElementById('roman-toggle');
    const drawToggle = document.getElementById('draw-toggle');
    const redCanvas = document.getElementById('red-canvas');
    const chordLabelsContainer = document.getElementById('chord-labels');
    const chordProgressionField = document.getElementById('chord-progression');

    // App state
    let state = {
      key: 'C', // Default key
      mode: 'ionian (major)', // Default mode
      showRomanNumerals: false,
      progression: []
    };

    // Mode name mapping (from dropdown to internal representation)
    const modeNameMap = {
      'Ionian': 'ionian (major)',
      'Aeolian': 'aeolian (minor)',
      'Dorian': 'dorian',
      'Phrygian': 'phrygian',
      'Lydian': 'lydian',
      'Mixolydian': 'mixolydian',
      'Locrian': 'locrian'
    };

    // Initialize with default settings
    modeSelect.selectedIndex = 1; // Default to Ionian (major)

    // Initialize the canvas context for chord highlighting
    const ctx = redCanvas.getContext('2d');
    const highlighter = new ChordHighlighter(ctx);

    // Map of scale degrees for each mode
    const SCALE_DEGREE_TRIADS = {
      'ionian (major)': ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'],
      'aeolian (minor)': ['i', 'ii°', 'III', 'iv', 'v', 'VI', 'VII'],
      'dorian': ['i', 'ii', 'bIII', 'IV', 'v', 'vi°', 'bVII'],
      'phrygian': ['i', 'bII', 'bIII', 'iv', 'v°', 'bVI', 'bVII'],
      'lydian': ['I', 'II', 'iii', '#iv°', 'V', 'vi', 'vii'],
      'mixolydian': ['I', 'ii', 'iii°', 'IV', 'v', 'vi', 'bVII'],
      'locrian': ['i°', 'bII', 'biii', 'iv', 'bV', 'bVI', 'bVII']
    };

    // Chord offset in circle of fifths based on mode
    // This defines how many positions to rotate the chord names for each mode
    const modeChordOffset = {
      'ionian (major)': 0,
      'aeolian (minor)': 9, // Rotate to A minor from C major (9 steps counterclockwise)
      'dorian': 10,         // Rotate to D dorian from C major
      'phrygian': 11,       // Rotate to E phrygian from C major
      'lydian': 11,         // Rotate to F lydian from C major
      'mixolydian': 10,     // Rotate to G mixolydian from C major
      'locrian': 8          // Rotate to B locrian from C major
    };

    // Calculate Roman numerals for given key and mode
    function getRomanNumerals(key, mode) {
      // Find the index of the key in the circle
      const keyIndex = CIRCLE_POSITIONS[RING.MAJOR].findIndex(chordName => {
        if (chordName.includes('/')) {
          return chordName.split('/').includes(key);
        }
        return chordName === key;
      });

      if (keyIndex === -1) return null;

      // Calculate offset based on key and mode
      let offset = (keyIndex - modeChordOffset[mode]) % 12;
      if (offset < 0) offset += 12;

      // Rotate the scale degrees based on the offset
      const scaleDegrees = [...SCALE_DEGREE_TRIADS[mode]];

      // Map each position to corresponding scale degree
      const romanMap = {};

      // Major chords
      for (let i = 0; i < 12; i++) {
        const posIndex = (i + offset) % 12;
        romanMap[`${RING.MAJOR}-${i}`] = scaleDegrees[posIndex % 7];
      }

      // Minor chords - for simplicity, use the same pattern shifted by relative minor
      for (let i = 0; i < 12; i++) {
        const posIndex = (i + offset + 9) % 12; // +9 for relative minor
        romanMap[`${RING.MINOR}-${i}`] = scaleDegrees[posIndex % 7];
      }

      // Diminished chords - simplified approach
      for (let i = 0; i < 12; i++) {
        const posIndex = (i + offset + 6) % 12; // +6 for diminished positioning
        romanMap[`${RING.DIMINISHED}-${i}`] = scaleDegrees[posIndex % 7];
      }

      return romanMap;
    }

    // Create and position chord labels in the circle
    function createChordLabels() {
      // Clear existing labels
      chordLabelsContainer.innerHTML = '';

      // Calculate Roman numerals if needed
      const romanMap = state.showRomanNumerals ? getRomanNumerals(state.key, state.mode) : null;

      // Loop through all chord positions
      Object.values(RING).forEach(ring => {
        for (let i = 0; i < 12; i++) {
          const chordName = getChordNameAtPosition(ring, i);
          const { angle, radius } = getChordPolarCoordinates(ring, i);
          const coords = polarToCartesian(angle, radius);

          // Create label element
          const label = document.createElement('div');
          label.className = `label ${ring}`;

          // Set label text based on mode (chord name or Roman numeral)
          if (state.showRomanNumerals && romanMap) {
            const romanId = `${ring}-${i}`;
            label.textContent = romanMap[romanId] || chordName;
          } else {
            label.textContent = chordName;
          }

          // Position the label
          label.style.left = `${coords.x}px`;
          label.style.top = `${coords.y}px`;

          // Highlight the tonic key if this is it
          if (ring === RING.MAJOR && chordName === state.key ||
              chordName.includes('/') && chordName.split('/').includes(state.key)) {
            label.classList.add('highlighted-key');
          }

          // Add to container
          chordLabelsContainer.appendChild(label);
        }
      });
    }

    // Update the circle when key or mode changes
    function updateCircle() {
      createChordLabels();
      updateChordProgression();
    }

    // Update chord progression display
    function updateChordProgression() {
      // Simplified implementation - just show selected chords
      const chordNames = highlighter.selectedChords.map(pos => {
        return getChordNameAtPosition(pos.ring, pos.index);
      });

      chordProgressionField.value = chordNames.join(' - ');
    }

    // Initialize the circle
    createChordLabels();

    // Configure highlighter style
    highlighter.outlineColor = 'rgba(255, 0, 0, 0.8)';
    highlighter.outlineWidth = 4;

    // Clear any previous highlights
    ctx.clearRect(0, 0, redCanvas.width, redCanvas.height);

    // Initialize empty chord progression field
    updateChordProgression();

    // Add click handler for selecting chords
    redCanvas.addEventListener('click', function(e) {
      const rect = redCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Calculate distance from center
      const dx = x - highlighter.centerX;
      const dy = y - highlighter.centerY;
      const distance = Math.sqrt(dx * dx + dy * dy);

      // Determine which ring was clicked
      let ring;
      if (distance > 130 && distance < 165) {
        ring = RING.MAJOR;
      } else if (distance > 90 && distance < 130) {
        ring = RING.MINOR;
      } else if (distance > 50 && distance < 90) {
        ring = RING.DIMINISHED;
      } else {
        return; // Click not in any ring
      }

      // Calculate angle and convert to index
      let angle = Math.atan2(-dy, dx);
      // Convert to angle from 12 o'clock position, clockwise
      angle = Math.PI/2 - angle;
      if (angle < 0) angle += 2 * Math.PI;

      // Convert angle to index (0-11)
      const index = Math.floor((angle / (2 * Math.PI)) * 12) % 12;

      // Toggle chord selection
      const existingIndex = highlighter.selectedChords.findIndex(
        pos => pos.ring === ring && pos.index === index
      );

      if (existingIndex !== -1) {
        highlighter.selectedChords.splice(existingIndex, 1);
      } else {
        highlighter.addChordByPosition(ring, index);
      }

      // Redraw highlights
      ctx.clearRect(0, 0, redCanvas.width, redCanvas.height);
      highlighter.drawHighlightsWithPath();

      // Update chord progression display
      updateChordProgression();
    });

    // Add event listeners for UI controls
    modeSelect.addEventListener('change', function() {
      // Map the selected mode name to internal representation
      state.mode = modeNameMap[this.value];
      updateCircle();
    });

    keySelect.addEventListener('change', function() {
      state.key = this.value;
      updateCircle();
    });

    // Roman numeral toggle
    romanToggle.addEventListener('click', function(e) {
      if (e.target.tagName === 'SPAN') {
        // Update active state
        romanToggle.querySelectorAll('span').forEach(span => {
          span.classList.remove('active');
        });
        e.target.classList.add('active');

        // Update state
        state.showRomanNumerals = (e.target.id === 'roman-roman');

        // Update circle
        updateCircle();
      }
    });

    // Clear button for chord progression
    document.getElementById('clear-drawings').addEventListener('click', function() {
      // Clear all selected chords
      highlighter.clearAll();

      // Clear canvas
      ctx.clearRect(0, 0, redCanvas.width, redCanvas.height);

      // Update chord progression display
      updateChordProgression();
    });
  </script>
</body>
</html>
